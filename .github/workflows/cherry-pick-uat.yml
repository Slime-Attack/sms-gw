name: Auto promote labeled PRs to UAT

on:
  pull_request:
    types: [closed]   # run when a PR is merged/closed

permissions:
  contents: write
  pull-requests: write

jobs:
  promote-to-uat:
    # only when merged AND the PR has the label promote:uat
    if: >
      github.event.pull_request.merged == true &&
      contains(github.event.pull_request.labels.*.name, 'promote:uat')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Promote this PR to UAT
        id: promote
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          PR: ${{ github.event.pull_request.number }}
          BASE: uat
        shell: bash
        run: |
          set -euo pipefail

          # Start from latest UAT
          git fetch origin "$BASE" --prune --tags
          TS=$(date -u +%Y%m%d-%H%M%S)
          BR="promote/${BASE}/pr-${PR}-${TS}"
          git checkout -B "$BR" "origin/$BASE"

          # Figure out the commit to cherry-pick (handles squash/merge)
          SHA="${{ github.event.pull_request.merge_commit_sha }}"
          if [ -z "${SHA}" ] || [ "${SHA}" = "null" ]; then
            SHA="$(gh pr view "$PR" --repo "$REPO" --json mergeCommit -q .mergeCommit.oid || true)"
          fi
          if [ -z "${SHA}" ] || [ "${SHA}" = "null" ]; then
            echo "❌ Can't determine merge commit for PR #$PR" >&2
            exit 1
          fi

          # Make sure we have the commit locally
          git fetch --no-tags --prune origin +refs/heads/*:refs/remotes/origin/*

          # Cherry-pick (try normal; if it's a merge commit, retry with -m 1)
          if git cherry-pick "$SHA"; then
            echo "✅ Cherry-picked $SHA"
          else
            echo "🔁 Retrying as merge commit (-m 1)..."
            git cherry-pick --abort || true
            git cherry-pick -m 1 "$SHA"
          fi

          git push -u origin "$BR"

          # Open PR to UAT
          URL=$(gh pr create \
            --repo "$REPO" \
            --base "$BASE" \
            --head "$BR" \
            --title "Promote to UAT: PR #$PR" \
            --body  "Cherry-picked PR #$PR into \`$BASE\`. Generated by workflow.")
          echo "url=$URL" >> "$GITHUB_OUTPUT"

      - name: Comment back on source PR
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          URL="${{ steps.promote.outputs.url || '' }}"
          MSG="Promoted to \`uat\` → ${URL:-_failed to open PR_}"
          gh pr comment "${{ github.event.pull_request.number }}" \
            --repo "${{ github.repository }}" \
            --body "$MSG"
