name: Cherry Pick to UAT

on:
  workflow_dispatch:
    inputs:
      pr_numbers:
        description: "Comma-separated PR numbers (e.g. 101,103)"
        required: true
      base:
        description: "Target env branch"
        required: true
        default: uat

permissions:
  contents: write
  pull-requests: write

jobs:
  promote:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare promotion branch
        id: prep
        shell: bash
        run: |
          set -euo pipefail
          BASE="${{ github.event.inputs.base }}"
          git fetch origin "$BASE" --prune --tags
          TS=$(date -u +%Y%m%d-%H%M%S)
          PROMO_BRANCH="promote/${BASE}/${TS}"
          git checkout -B "$PROMO_BRANCH" "origin/$BASE"
          echo "branch=$PROMO_BRANCH" >> "$GITHUB_OUTPUT"

      - name: Cherry-pick selected PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PRS:  ${{ github.event.inputs.pr_numbers }}
        shell: bash
        run: |
          set -euo pipefail
          IFS=',' read -ra LIST <<< "$PRS"
          git fetch origin "+refs/heads/*:refs/remotes/origin/*" --tags

          for raw in "${LIST[@]}"; do
            PR=$(echo "$raw" | xargs)
            echo "::group::Cherry-pick PR #$PR"
            # Get the merge commit SHA created when the PR was merged into develop
            SHA=$(gh api repos/$REPO/pulls/$PR -q .merge_commit_sha)
            if [ -z "${SHA:-}" ] || [ "$SHA" = "null" ]; then
              echo "PR #$PR is not merged or SHA unavailable. Aborting." >&2
              exit 1
            fi

            # Try as normal commit first; if it's a merge commit, retry with -m 1
            if git cherry-pick "$SHA"; then
              echo "Cherry-picked $SHA"
            else
              echo "Retrying as merge commit (-m 1)..."
              git cherry-pick --abort || true
              git cherry-pick -m 1 "$SHA"
            fi
            echo "::endgroup::"
          done

      - name: Push promotion branch
        run: git push -u origin "${{ steps.prep.outputs.branch }}"

      - name: Open PR into UAT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --base "${{ github.event.inputs.base }}" \
            --head "${{ steps.prep.outputs.branch }}" \
            --title "Promote to ${{ github.event.inputs.base }}: PRs ${{ github.event.inputs.pr_numbers }}" \
            --body  "Cherry-picked PRs ${{ github.event.inputs.pr_numbers }} into ${{ github.event.inputs.base }}."
